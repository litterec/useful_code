var ncols;var browse_cmprlist_block;var add_to_compare;var cr=String.fromCharCode(10);var cmpr_block='<div id="cmpr_container" class="cmprlist">'+cr+'<div id="no_cmpr"><div>Ни один товар не был добавлен в список сравнений</div></div>'+cr+'</div>'+cr;//var title_len_rules= {0:400,1:200,2:120,3:100,4:70,5:50,6:30,7:20};var title_len_rules= [400,200,120,100,70,50,30,20];var descr_len_rules= [800,550,350,220,160,130,90,40];var excrpt_len_rules= [950,500,250,180,125,92,66,40];var cmpr_title_wd_rules= [500,400,300,200,150,140,130,120];function recalc_ncols()       {ncols=jQuery('.prodline:nth-of-type(1) .prodbody>div>div>div[prodid]').length;       } // The end of recalc_ncolsfunction crop_some_string(src_str,required_len)       {if(required_len<3){    return src_str.substr(0,3);}if(src_str.length>required_len){    return src_str.substr(0,required_len-2)+'&hellip;';}return src_str;       } // The end of crop_some_stringfunction adjust_cmpr_cntnt()       {//console.log('Len='+ncols);if(ncols>rasolo_params.cmpr_max)return false;var actual_length=title_len_rules[ncols];//console.log('actual_length='+actual_length);var actual_width=cmpr_title_wd_rules[ncols];jQuery('.prodline:nth-of-type(1) .prodbody>div>div>div').each(function(index){//    console.log('index='+index);//    console.log(this);    var prod_title_anc=jQuery(this).find('.cmpr_title a').first();    var txt_storage=prod_title_anc.attr('txt-storage');    if(txt_storage===undefined){       throw new Error('The anchor element doesn\'t have txt-storage attr!');    }    if(prod_title_anc.html().length>actual_length){        prod_title_anc.attr('title',txt_storage);        prod_title_anc.html(crop_some_string(txt_storage,actual_length));    } else {       prod_title_anc.html(txt_storage);       prod_title_anc.removeAttr('title');    }//    console.log(jQuery(this).find('.cmpr_title a').first().html());    if(actual_width===undefined){       throw new Error('The anchor element doesn\'t have width data!');    }    var cmpr_title_div=jQuery(this).find('.cmpr_title').first();    cmpr_title_div.width(actual_width);});actual_length=descr_len_rules[ncols];//jQuery('.prodline:nth-of-type(3) .prodbody>div>div>div').each(function(index){jQuery('.prodline[rasolo_key="description"] .prodbody>div>div>div').each(function (index) {    var txt_storage=jQuery(this).attr('txt-storage');    if(txt_storage===undefined){       throw new Error('The description div doesn\'t have txt-storage attr!');//    } else {//        console.log('The description is: '+txt_storage);    }    if(txt_storage.length>actual_length){        jQuery(this).attr('title',actual_length+txt_storage);        jQuery(this).html(crop_some_string(txt_storage,actual_length));    } else {        jQuery(this).html(txt_storage);        jQuery(this).removeAttr('title');    }});actual_length=excrpt_len_rules[ncols];//jQuery('.prodline:nth-of-type(4) .prodbody>div>div>div').each(function(index){jQuery('.prodline[rasolo_key="shrt_dscr"] .prodbody>div>div>div').each(function(index){    var txt_storage=jQuery(this).attr('txt-storage');    if(txt_storage===undefined){       throw new Error('The excerpt div doesn\'t have txt-storage attr!');//    } else {//        console.log('The excerpt is: '+txt_storage);    }    if(txt_storage.length>actual_length){        jQuery(this).attr('title',actual_length+txt_storage);        jQuery(this).html(crop_some_string(txt_storage,actual_length));    } else {        jQuery(this).html(txt_storage);        jQuery(this).removeAttr('title');    }})       } // The end of adjust_cmpr_cntntfunction addcmpr_show_change()       {var new_action_block = browse_cmprlist_block.find('.new_action_block').first();//console.log('new_action_block :');//console.log(new_action_block );var result_block = browse_cmprlist_block.find('.result_block').first();//console.log('result_block :');//console.log(result_block );	       /*	console.log('browse_cmprlist_block:');	console.log(browse_cmprlist_block);	console.log('browse_cmprlist_block.html:' + browse_cmprlist_block.html());	console.log('add_to_compare 03526:');	console.log(add_to_compare);	console.log('add_cmpr_block.html:'+ add_to_compare.html());	console.log('new_action_block:');	console.log(new_action_block);	console.log('new_action_block.html='+new_action_block.html());	console.log('result_block:');	console.log(result_block);	console.log('result_block.html='+result_block.html());	//throw new Error('Stop0024');	*/add_to_compare.fadeOut(200,function(){	result_block.fadeIn( 200 , function(){		result_block.delay(1000).fadeOut( 200 , function(){			new_action_block.fadeIn( 200 );        });    });});//	       browse_cmprlist_block.find('.view_cmpr_list').hide();//	       throw new Error('Stop002');//$('.view_cmpr_list').hide();//browse_cmprlist_block.fadeIn( 200 , function(){//    browse_cmprlist_block.children().first().delay(1600).fadeOut( 600 , function(){//            browse_cmprlist_block.find('.view_cmpr_list').fadeIn( 600 );//    });//});       } // The end of addcmpr_show_change       jQuery(document).ready(function($){recalc_ncols();adjust_cmpr_cntnt();var cmpr_compare = new RasoloWishCompare();//var testcmpr=cmpr_compare.get_cmpr();//console.log('after get testcmpr:');//console.log(testcmpr);//cmpr_compare.add_cmpr(188);//cmpr_compare.write_cookies();//var testcmpr2=cmpr_compare.get_cmpr();//console.log('after 2 get testcmpr:');//console.log(testcmpr2);//throw new Error('Cmpr Cookies test exit');$('.close-wnd').click(function() {//        document.getElementById("lgn_frm").style.display="none";//        alert('cross is pressed');    $('#lgn_frm').hide();});$('#lgn_frm').click(function(event) {    var senderElementName = event.target.id.toLowerCase();     if(senderElementName === 'lgn_frm'){            $(this).hide();     };//        alert('cross is pressed');});$('#sgnin_wnd').click(function() {//            alert('jQuery is pressed');    $('#lgn_frm').show();});$( ".remove_from_cmprlist" ).click(function(event) {    event.preventDefault();    var event_target_i=$(event.target);    var div_prodid=event_target_i.parent().parent().parent().parent();//    console.log('div_prodid='+div_prodid.attr('prodid'));    var prodid=parseInt(div_prodid.attr('prodid'));    $('.prodbody div[prodid]').each( function(){            var div_with_prodid=$(this);            if(parseInt(div_with_prodid.attr('prodid'))==prodid){                $(this).removeAttr('prodid');                $(this).hide('slow',function(){                    div_with_prodid.remove().queue(function(){                        recalc_ncols();                        adjust_cmpr_cntnt();//                        console.log('Recalculated:'+ncols);                    });                });            }        }    );    jQuery('.prodline:nth-of-type(1) .prodbody>div>div>div').each(        function(){            adjust_cmpr_cntnt();        }    );//    throw new Error('We will adjust that later');    var col_target=event_target_i.parent();    var top_cmprlist=col_target.parent();//    console.log('removing!');//    var rm_elm_id=col_target.attr('id');//    var rm_item_id=false;//    if(rm_elm_id.substr(0,10)=='wish-item-'){//        rm_item_id=rm_elm_id.substr(10);//        console.log(rm_item_id);//    }//    var rm_item_id_num=parseInt(rm_item_id);//    if(rm_item_id_num>0)    if(prodid>0){//        var arr = {prod_id:rm_item_id_num, wh_cmp_action:"remove_from_cmpr"};        var arr = {prod_id:prodid, wh_cmp_action:"remove_from_cmpr"};        var serializedArr = $.param(arr);        if(parseInt(rasolo_params.this_user)>0){            $.ajax({                  type: "POST",                  url: rasolo_params.theme_url+"cmpr_list_reply.php",                  data: serializedArr,                  success: function(msg) {    //                  console.log('It returned something after item removing:'+msg+'{==');                      var msg_arr=msg.split('@@@rasolo_sep@@@');                      if(isset(msg_arr[1])){    //                      console.log(msg_arr);                          try {                              var returned_parms=JSON.parse(msg_arr[0]);                          } catch (_error){                              console.log('Error 2082! the msg arr is'+msg_arr[0]+'{==');                              returned_parms=false;                          }//                          console.log(returned_parms);                          var debug_msg=msg_arr[1];                      } else {                            var debug_msg=msg_arr[0];                      };    //                  console.log(debug_msg);    //                  col_target.remove();                      col_target.hide('slow', function(){ col_target.remove().each(                          function() {    // console.log('Wishlist has as many as '+top_cmprlist.children().length+' children');    // console.log('The Wishlist children html is '+top_cmprlist.children().first().html()+' !!!');    // console.log(top_cmprlist.get( 0 ));    // console.log('Wishlist name is '+top_cmprlist.get(0).tagName+' !');                      if(top_cmprlist.children().length<2){                          top_cmprlist.html(cmpr_block);                      };                                     }                      ); });                      remove_ajax_handlers();                  //alert ('msg='+msg+'{==');    //                        remove_ajax_handlers();    //                        $('#note_jquery').html(msg);    //                        document.getElementById('contacts').innerHTML='';                  }            });        } else {//            cmpr_compare.remove_cmpr(rm_item_id_num);            cmpr_compare.remove_cmpr(prodid);            cmpr_compare.write_cookies();//            var after_some_item_emove_rc=cmpr_compare.write_cookies();//            console.log('after_some_item_emove_rc'+after_some_item_emove_rc);            var cookie_rm_success=cmpr_compare.get_error_code();//            console.log('After removing rm_item_id_num, error_code'+cmpr_compare.get_error_code());//            console.log('After removing rm_item_id_num, error_msg'+cmpr_compare.get_error_msg());             if(!cookie_rm_success){//                      console.log('cookie_rm_success');  /*                  col_target.hide('slow', function(){ col_target.remove().each(                      function() {                  if(top_cmprlist.children().length<2){                      top_cmprlist.html(cmpr_block);                  }                                 }                  ); });*/                  remove_ajax_handlers();             }        }    }});// Add to cmprlist/compare software$( ".add_to_cmprlist" ).click(function(event) {    event.preventDefault();//        var tn=$(event.target).parent().prop("tagName");//        var tn = $(event.target).parents().map(function() {//            return this.tagName;//        }).get().join( ", " );    var post_id=false;    var event_target=$(event.target);	if(rasolo_params.page_type=='shop'){        var product_parent_li=event_target.closest('li').            first();	    browse_cmprlist_block = product_parent_li.		    find('.rasolo_added_browse_cmprlist_block').		    first();		add_to_compare= product_parent_li.			find('.rasolo_add_to_compare_block').			first();	    var product_img_obj = product_parent_li.		    find('img.wp-post-image').		    first();		$(event_target).            parents().            filter('li').            first().            attr('class').            split(' ').            map(function(cls){                if(cls.substr(0,5)=='post-'){                    post_id=cls.substr(5);        //            console.log('cls.substr(1, 4)='+cls.substr(1, 4)+', post_id='+post_id);                    return true;                }        });    } else if(rasolo_params.page_type=='product') {		var product_parent_li = event_target.closest('div.single-product-wrapper').			first();		browse_cmprlist_block = product_parent_li.			find('.rasolo_added_browse_cmprlist_block').			first();		add_to_compare = product_parent_li.			find('.rasolo_add_to_compare_block').			first();		var product_img_obj = product_parent_li.			find('img.wp-post-image').			first();//		console.log('product_parent_li:');//		console.log(product_parent_li);//		console.log('browse_cmprlist_block:');//		console.log(browse_cmprlist_block);//		console.log('rasolo_params.page_type=' + rasolo_params.page_type + ', product_img_obj');//		console.log(product_img_obj);		/*				var product_parent_li=event_target.closest('div.product');				browse_cmprlist_block = product_parent_li.					find('.rasolo_added_browse_cmprlist_block').					first();				var product_img_obj = product_parent_li.					children('a:first-child').					first().					children('img:first-child');		*/	    var id_prod_elm=$(event_target).                parents().closest('div.product').                attr('id');        if(id_prod_elm.substring(0,8)=='product-'){            post_id=parseInt(id_prod_elm.substring(8));//            console.log('id_prod_elm='+id_prod_elm+', post_id='+post_id);        } else {            throw new Error('Incorrect product DOM logic');        }    } else {		var product_parent_li = event_target.closest('div.product');	    browse_cmprlist_block = event_target.closest('div.product').		    find('.rasolo_added_browse_cmprlist_block').		    first();		add_to_compare = event_target.closest('div.product').			find('.rasolo_add_to_compare_block').			first();		var product_img_obj = event_target.closest('div.product').			find('img.attachment-woocommerce_thumbnail').			first();		post_id = event_target.attr('data-product_id');    }//	console.log('product_img_obj');//	console.log(product_img_obj);//	console.log('post_id='+ post_id);//	console.log(event_target);    var post_id_num=parseInt(post_id);    if(post_id_num>0){//        var info_cmprlist=product_parent_li.//            find('.cmpr_ajax_result').//            first();        var info_cmprlist= event_target.closest('.rasolo_wishcompare_block').            find('.cmpr_ajax_result').            first();//        var product_img_obj=product_parent_li.//            children('a:first-child').//            first().//            children('img:first-child');        product_img_obj.fadeTo( "fast", 0.33 );        var loader_size=44;        var prod_img_width=product_img_obj.width();        var prod_img_height=product_img_obj.height();        var left_offset= parseInt((prod_img_width-loader_size)/2).toString();        var top_offset= parseInt((prod_img_height-loader_size)/2).toString();        product_img_obj.next().show();//            console.log ('add_to_cmprlist ==}'+post_id+'{==, rasolo_params.theme_url ==}'+theme_path+'{==');//            var arr = [ 1, 2, 3 ];        var arr = {prod_id:post_id_num, wh_cmp_action:"add_to_cmpr", age:46};//            var serializedArr = JSON.stringify( arr );        var serializedArr = $.param(arr);        if(parseInt(rasolo_params.this_user)>0){            $(document).ajaxSend(function(event, request, settings) {                product_img_obj.after('<img class="ajax_loader" style="left:'+                    left_offset+'px; top:'+                    top_offset+'px;" src="'+                    rasolo_params.theme_url+'assets/images/ajax-loader.gif">');//	                throw new Error('Let us soo the ajax_loader');            });            $(document).ajaxComplete(function(event, request, settings) {                jQuery('.ajax_loader').remove();            });            $.ajax({                  type: "POST",                  url: rasolo_params.theme_url+"cmpr_list_reply.php",                  data: serializedArr,                  success: function(msg) {    //                  console.log('It returned something after item addition:'+msg+'{==');                      jQuery('.ajax_loader').remove();                      jQuery(document).unbind("ajaxComplete");                      jQuery(document).unbind("ajaxSend");	                  var msg_arr=msg.split('@@@rasolo_sep@@@');//	                  console.log('We have the user msg_arr ' + rasolo_params.this_user);//	                  console.log(msg);	                  if(isset(msg_arr[1])){//                          console.log('msg_arr:');//                          console.log(msg_arr);                          try {                              var returned_parms=JSON.parse(msg_arr[0]);                          } catch (_error){                              console.log('Error 2083! the msg arr is'+msg_arr[0]+'{==');                              returned_parms=false;                          }//                          console.log('returned_parms');//                          console.log(returned_parms);//                          console.log('returned_parms.added_item_typeof='+typeof returned_parms.added_item);                          if(parseInt(returned_parms.added_item)>=0){                              info_cmprlist.removeClass('operation_failed');                              info_cmprlist.addClass('operation_success');    //                          console.log('Good');//                              event_target.parent().hide();    //                          if('array_is_full')                              info_cmprlist.html('№ '+post_id_num+' добавлен');                          } else if(returned_parms.error) {                              info_cmprlist.removeClass('operation_success');                              info_cmprlist.addClass('operation_failed');    //                          console.log('Overflow :(');//                              console.log('returned_parms:');//                              console.log(returned_parms);                              event_target.parent().hide();    //                          if('array_is_full')                              if(returned_parms.error==409){                                    info_cmprlist.html('Максимум '+rasolo_params.cmpr_max+' шт.');                                    $('.view_cmpr_list').text('Чистить сравнения');                              } else if(returned_parms.error==404) {                                    info_cmprlist.html('Товар уже был в списке');                              } else  {                                    info_cmprlist.html('Ничего не получилось');                              };                          } else {                              console.log('Bad unknown error!');                              info_cmprlist.html('Неизвестная ошибка!_001!_');                          };                          addcmpr_show_change();                          var debug_msg=msg_arr[1];                      } else {                          var debug_msg=msg_arr[0];                      };    //                  console.log(debug_msg);                      // , function(){ col_target.remove(); }                      product_img_obj.fadeTo( "fast", 1. );                      remove_ajax_handlers();                  //alert ('msg='+msg+'{==');    //                        remove_ajax_handlers();    //                        $('#note_jquery').html(msg);    //                        document.getElementById('contacts').innerHTML='';                  }            });        } else if(navigator.cookieEnabled) {            product_img_obj.delay(500).fadeTo( "fast", 1.);            product_img_obj.after('<img class="ajax_loader" style="left:'+                    left_offset+'px; top:'+                    top_offset+'px;" src="'+                    rasolo_params.theme_url+'img/ajax-loader.gif">');//            console.log('Let us write cookie, test_available_cmpr:');            var test_available_cmpr=cmpr_compare.get_cmpr();//            console.log(test_available_cmpr);            var test_available_cmpr_msg=cmpr_compare.get_error_msg();            var test_available_cmpr_code=cmpr_compare.get_error_code();//            console.log(test_available_cmpr_code+', ERR Message: '+test_available_cmpr_msg);            var new_item_add_rc=cmpr_compare.add_cmpr(post_id_num);            var after_cmpr_addition_rc=cmpr_compare.get_error_code();//            console.log('new_item_add_rc='+new_item_add_rc);//            console.log('After addition post_id_num, error_code'+after_cmpr_addition_rc);//            console.log('After addition post_id_num, error_msg'+cmpr_compare.get_error_msg());            var after_new_item_write_rc=cmpr_compare.write_cookies();//            console.log('after_new_item_write_rc='+after_new_item_write_rc);            var after_write_addition_errnum=cmpr_compare.get_error_code();//            console.log('After writing addition results, error_code'+after_write_addition_errnum);//            console.log('After writing addition results, error_msg'+cmpr_compare.get_error_msg());//            var prod_id=get_my_cookie('prod_id');//            if(new_item_add_rc){            if(!after_cmpr_addition_rc && !after_write_addition_errnum){                info_cmprlist.html('№ '+post_id_num+' добавлен');                info_cmprlist.removeClass('operation_failed');                info_cmprlist.addClass('operation_success');            } else if(after_cmpr_addition_rc==501) {                info_cmprlist.html('Максимум: '+cmpr_compare.get_options().cmpr_cpcty+' шт.');  // rasolo_params.cmpr_max                info_cmprlist.removeClass('operation_success');                info_cmprlist.addClass('operation_failed');            } else if(after_cmpr_addition_rc==503) {                info_cmprlist.html('№ '+post_id_num+' уже в списке');                info_cmprlist.removeClass('operation_success');                info_cmprlist.addClass('operation_failed');            } else if(after_cmpr_addition_rc==502) {                info_cmprlist.html('Неверные данные: '+after_write_addition_errnum+'!');                info_cmprlist.removeClass('operation_success');                info_cmprlist.addClass('operation_failed');            } else {                info_cmprlist.html('Неизвестная ошибка ('+post_id_num+')');                info_cmprlist.removeClass('operation_success');                info_cmprlist.addClass('operation_failed');            }            event_target.parent().hide();//            console.log('prod_id_sdn_encoded='+prod_id_sdn_encoded+'{==');//            console.log('------The beginning---------document.cookie');//            console.log(document.cookie);//            console.log('---------The end--document.cookie');            addcmpr_show_change();            product_img_obj.promise().done( function() {                $('.ajax_loader').remove();            } );        } else {            console.log('Let us call session');        };    }});//    $(document).ajaxSend(function(event, request, settings) {//        console.log('itwassent!!!');//        document.getElementById(trigger_switch[wnd]).innerHTML='<img src=/images/ajax_loader.gif>';//    });       });  // The end of JQuery.ready